/*
Project Name: GA Aware
URL: https://github.com/keobrien/GA-Aware
Author: Kevin O'Brien
Company: Clockwork Acive Media Systems
Company Site: clockwork.net
License: MIT
Copyright (C) 2012 Clockwork Active Media Systems
Version: 1.9.1
**************************************/
(function(g){g.fn.gaaware=function(c){return new g.gaaware(this,c)};g.gaaware=function(c,b){this.s=g.extend({UA:"UA-XXXXX-X",d:window.document.domain,domains:[],include_only:null,exclude_subdomains:"preview dev test stage review demo train".split(" "),asset_extentions:"pdf txt csv doc docx xls xlsx ppt jpg jpeg png gif psd ai eps zip xml json avi mp4 mp3 mov mpeg wmv rtf swf flv js css eot svg ttf woff otf".split(" "),track_alt_protocols:["mailto","spotify","ftp","file","tel"],vpv_prefix:"/vpv",track_external_links:!0,external_prefix:"External",asset_prefix:"Asset",hash_prefix:"Hash",external_form_prefix:"Form",track_as_events:!0,debug:!1,debug_mode:function(b){console.info(b)},track:!0,no_track_class:"ga_notrack",custom_vars:[],auto_social:!1,social_page_url:null,enable_facebook:!0,enable_twitter:!0,prefer_title:!0,track_right_clicks:!0,bouce_defeat:3E4,session_keeper:15E5,dow_custom_var:4,hod_custom_var:5},b);if(this.s.track)return window._gaq=window._gaq||[],this.current_domain_state=null,this.track_multi=this.s.UA.constructor===Array?!0:!1,this.first_load=this.cross_domain_disabled=!1,this.s.UA=this.track_multi?this.s.UA:[this.s.UA],this.setup(),this};g.gaaware.prototype={setup:function(){var c=this;if(this.s.track){var b=!1,e=!1;g(document.cookie.split(";")).each(function(){var a=this.substr(0,this.indexOf("=")).replace(/ /g,"");"__utmb"==a&&(b=!0);"__utmc"==a&&(e=!0)});if(!b||!e)this.first_load=!0;this.s.debug&&this.s.debug_mode("GA First View In Session: "+this.first_load);for(var a=!1,d=!1,f=0;f<this.s.custom_vars.length;f++)this.s.dow_custom_var&&this.s.custom_vars[f][0]==this.s.dow_custom_var&&(a=!0),this.s.hod_custom_var&&this.s.custom_vars[f][0]==this.s.hod_custom_var&&(d=!0);!a&&this.s.dow_custom_var?this.s.custom_vars.push([this.s.dow_custom_var,"Day Of Week",(new Date).getDay().toString()]):this.s.debug&&this.s.debug_mode("Day of Week custom variable not set or in conflict, not tracking in slot "+this.s.dow_custom_var);!d&&this.s.hod_custom_var?this.s.custom_vars.push([this.s.hod_custom_var,"Hour of Day",(new Date).getHours().toString()]):this.s.debug&&this.s.debug_mode("Hour of Day custom variable not set or in conflict, not tracking in slot "+this.s.hod_custom_var);if(this.s.include_only&&!this.match_domain(this.s.d,this.s.include_only)[0])this.s.track=!1,this.s.debug&&this.s.debug_mode("Current Domain not part of this.s.include_only");else{if(this.s.exclude_subdomains){f=this.s.d.split(".");for(d=0;d<this.s.exclude_subdomains.length;d++)for(a=0;a<f.length;a++)if(f[a]==this.s.exclude_subdomains[d]){this.s.debug&&this.s.debug_mode("Tracking off: current domain contains an excluded sub domain in this.s.exclude_subdomains: "+this.s.exclude_subdomains[d]);this.s.track=!1;return}}for(f=0;f<this.s.UA.length;f++){a=0==f?"":"t"+(f+1)+".";window._gaq.push([a+"_setAccount",this.s.UA[f]]);0<this.s.domains.length?(this.current_domain_state=this.match_domain(this.s.d),this.current_domain_state[1]?(window._gaq.push([a+"_setDomainName",this.current_domain_state[1]]),this.s.debug&&this.s.debug_mode("_setDomainName set to: "+this.current_domain_state[1]),window._gaq.push([a+"_setAllowLinker",!0]),this.s.debug&&this.s.debug_mode("_setAllowLinker set to true"),window._gaq.push([a+"_setAllowAnchor",!0]),this.s.debug&&this.s.debug_mode("_setAllowAnchor set to true"),this.s.debug&&this.s.debug_mode("Cross domain active")):(this.cross_domain_disabled=!0,this.s.debug&&(this.s.debug_mode("Error: Cross domain defined but current domain not included, deactivating cross domain"),this.s.debug_mode("current domain: "+this.s.d),this.s.debug_mode("cross domain definition: "+this.s.domains)))):this.cross_domain_disabled=!0;for(d=0;d<this.s.custom_vars.length;d++)this.track_custom(this.s.custom_vars[d][0],this.s.custom_vars[d][1],this.s.custom_vars[d][2],this.s.custom_vars[d][3]),this.s.debug&&this.s.debug_mode("tracking custom variable: "+this.s.custom_vars[d][0]+" "+this.s.custom_vars[d][1]+" "+this.s.custom_vars[d][2]+" "+this.s.custom_vars[d][3]);window._gaq.push([a+"_trackPageview"]);this.s.debug&&this.s.debug_mode(this.s.UA[f]+" active!")}f=document.createElement("script");f.type="text/javascript";f.async=!0;f.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(f,a);if(c.s.auto_social&&(this.s.enable_facebook&&(window.fbAsyncInit=function(){c.setup_social_facebook(c.s.social_page_url);g(document).ready(function(){g("body").prepend('<div id="fb-root"></div>')})},a=document.getElementsByTagName("script")[0],document.getElementById("facebook-jssdk")||(f=document.createElement("script"),f.id="facebook-jssdk",f.src=("https:"==document.location.protocol?"https://":"http://")+"connect.facebook.net/en_US/all.js#xfbml=1",a.parentNode.insertBefore(f,a))),this.s.enable_twitter)){f=window;var h,d=document.getElementsByTagName("script")[0];document.getElementById("twitter-wjs")?a=void 0:(a=document.createElement("script"),a.id="twitter-wjs",a.src=("https:"==document.location.protocol?"https://":"http://")+"platform.twitter.com/widgets.js",d.parentNode.insertBefore(a,d),a=window.twttr||(h={_e:[],ready:function(a){h._e.push(a)}}));f.twttr=a;window.twttr.ready(function(){c.setup_social_twitter(c.s.social_page_url)})}this.s.bouce_defeat&&this.first_load&&setTimeout(function(){c.track_event("(Ignore Report)","Bounce Defeat",c.s.bouce_defeat)},c.s.bouce_defeat);this.s.session_keeper&&setInterval(function(){c.track_event("(Ignore Report)","Keep Session Open",c.s.session_keeper)},c.s.session_keeper);g(document).delegate('a:not(a[href^="javascript:"], a.'+c.s.no_track_class+")","click",c,c.link_clicks);g(document).delegate('a:not(a[href^="javascript:"], a.'+c.s.no_track_class+")","mousedown",c,c.eval_mouseup);g(document).delegate("form:not(form."+c.s.no_track_class+")","submit",c,c.submit_forms)}}},eval_mouseup:function(c){var b=c.data;if(b.s.track_right_clicks)switch(c.which){case 2:b.link_clicks(c,!0);break;case 3:b.link_clicks(c,!0)}},link_clicks:function(c,b){var e=c.data;if(e.s.track){var a=jQuery(c.currentTarget),d=a.attr("href");if(d){var f=d.split("/");if("http:"==f[0]||"https:"==f[0]||"//"==d.substr(0,2))var h=e.cross_domain_disabled?[null]:e.match_domain(f[2]);var i=d;e.s.prefer_title&&a.attr("title")&&(i=a.attr("title"));if(("http:"==f[0]||"https:"==f[0]||"//"==d.substr(0,2))&&!h[4])!h[0]&&e.cross_domain_disabled?e.s.track_external_links&&(b?e.link_virtual(c,a,d,i,!0,e.s.external_prefix):e.link_virtual(c,a,d,i,!1,e.s.external_prefix)):h[2]!=e.current_domain_state[2]&&!b&&(a.attr("target")&&"_self"!=a.attr("target")?(c.preventDefault(),window.open(window._gat._getTrackerByName()._getLinkerUrl(g(a).attr("href")),g(a).attr("target"))):(c.preventDefault(),window._gaq.push(["_link",a.attr("href")])));else{path=d.split("?")[0].split("#")[0];"/amm/author/lookup_page.php"==path&&(path=d.split("&url=")[1].split("&")[0].split("#")[0].split("%3F")[0]);f=path.split(".");extension=f[f.length-1];for(f=0;f<e.s.asset_extentions.length;f++)extension==e.s.asset_extentions[f]&&(b?e.link_virtual(c,a,d,i,!0,e.s.asset_prefix):e.link_virtual(c,a,d,i,!1,e.s.asset_prefix));"#"==d[0]&&(d=document.location.pathname+document.location.search+d,a.attr("target")&&"_self"!=a.attr("target")||e.link_virtual(c,a,d,i,!0,e.s.hash_prefix));if(h=d.split(":")[0])for(f=0;f<e.s.track_alt_protocols.length;f++)h==e.s.track_alt_protocols[f]&&e.link_virtual(c,a,d,i,!0,e.s.track_alt_protocols[f])}}}},submit_forms:function(c){var b=c.data;if(b.s.track){var e=jQuery(c.currentTarget);try{var a=e.attr("action");if(a){var d=a.split("/");if("http:"==d[0]||"https:"==d[0]||"//"==a.substr(0,2)){var f=b.cross_domain_disabled?[null]:b.match_domain(d[2]);f[0]?f[2]!=b.current_domain_state[2]&&("get"==e.attr("method").toLowerCase()?_gaq.push(["_linkByPost",c.target,!0]):_gaq.push(["_linkByPost",c.target])):f[4]?b.s.debug&&b.s.debug_mode("Form skipped, absolute but links to same domain: "+e):(b.s.track_as_events?b.track_event(b.s.external_form_prefix,b.s.external_prefix,a.toString()):b.track_virtual(b.s.external_prefix+"/"+b.s.external_form_prefix+"/"+a),e.attr("target")&&"_self"!=e.attr("target")||b.pause())}}}catch(g){b.s.debug&&(b.s.debug_mode("error converting form: "+g),b.s.debug_mode(e))}}},match_domain:function(c,b){if(this.s.track){for(var b=b?b:this.s.domains,c=this.remove_www(c),e=this.remove_www(this.s.d)==c?!0:!1,a=0;a<b.length;a++)if(b[a].entity){var d=this.remove_www(b[a].entity);if(d==c)return[1,d,a,!1,e];for(var f=0;f<b[a].subs.length;f++)if(b[a].subs[f]+"."+d==c)return[2,d,a,f,e]}else if(this.remove_www(b[a])==c)return[3,"none",a,!1,e];return[null,null,null,null,e]}},remove_www:function(c){var b=c.split(".");"www"==b[0]&&(b.splice(0,1),c=b.join("."));return c=c.split("/")[0].split("?")[0].split("#")[0]},link_virtual:function(c,b,e,a,d,f){if(this.s.track){b=g(b);a=a?a:e;if(this.s.track_as_events)this.track_event("Link",f,a);else for(c=0;c<this.s.UA.length;c++)window._gaq.push([(0==c?"":"t"+(c+1)+".")+"_trackPageview",this.s.vpv_prefix+"/"+f+"/"+a]);b.attr("target")&&"_self"!=b.attr("target")?!this.s.track_as_events&&this.s.debug&&this.s.debug_mode("virtual link for new window tracked to: "+this.s.vpv_prefix+"/"+f+"/"+a):(!this.s.track_as_events&&this.s.debug&&this.s.debug_mode("virtual link tracked to: "+this.s.vpv_prefix+"/"+f+"/"+a),d||this.pause())}},pause:function(){_gaq.push(function(){for(var c=new Date,b=c.getTime()+100;c.getTime()<b;)c=new Date})},extract_param_from_uri:function(c,b){if(c)for(var e=decodeURI(c.split("#")[1]),b=b+"=",e=e.split("&"),a=0,d;d=e[a];++a)if(0===d.indexOf(b))return unescape(d.split("=")[1])},setup_social_facebook:function(c){var b=this;if(b.s.enable_facebook)try{FB.Event.subscribe("edge.create",function(a){b.track_social("facebook","like",a,c);b.s.debug&&b.s.debug_mode("Facebook Like captured")}),FB.Event.subscribe("edge.remove",function(a){b.track_social("facebook","unlike",a,c);b.s.debug&&b.s.debug_mode("Facebook Unlike captured")}),FB.Event.subscribe("message.send",function(a){b.track_social("facebook","send",a,c);b.s.debug&&b.s.debug_mode("Facebook Send captured")})}catch(e){b.s.debug&&b.s.debug_mode("Social Tracking enabled but Facebook has an error:"+e)}},setup_social_twitter:function(c){var b=this;if(b.s.enable_twitter)try{twttr.events.bind("tweet",function(a){if(a){var d=document.location;a.target&&"IFRAME"==a.target.nodeName&&(d=b.extract_param_from_uri(a.target.src,"url"));b.track_social("twitter","tweet",d,c);b.s.debug&&b.s.debug_mode("Twitter event captured: "+d)}}),twttr.events.bind("click",function(a){a&&(b.track_social("twitter","click",document.location,c),b.s.debug&&b.s.debug_mode("Twitter click event"))}),twttr.events.bind("retweet",function(a){a&&(a=a.data.source_tweet_id,b.track_social("twitter","retweet",a,c),b.s.debug&&b.s.debug_mode("Twitter retweet event for tweet id "+a))}),twttr.events.bind("favorite",function(a){a&&(a=a.data.tweet_id,b.track_social("twitter","favorite",a,c),b.s.debug&&b.s.debug_mode("Twitter favorite event for tweet id "+a))}),twttr.events.bind("follow",function(a){a&&(a=a.data.user_id+" ("+a.data.screen_name+")",b.track_social("twitter","follow",a,c),b.s.debug&&b.s.debug_mode("Twitter follow event for user "+a))})}catch(e){this.s.debug&&this.s.debug_mode("Social Tracking enabled Twitter had an error:"+e)}},track_virtual:function(c){if(this.s.track&&c){for(var b=0;b<this.s.UA.length;b++)window._gaq.push([(0==b?"":"t"+(b+1)+".")+"_trackPageview",this.s.vpv_prefix+"/"+c]);this.s.debug&&this.s.debug_mode("virtual page view tracked to: "+this.s.vpv_prefix+c)}},track_event:function(c,b,e,a){if(this.s.track){for(var d=0;d<this.s.UA.length;d++)window._gaq.push([(0==d?"":"t"+(d+1)+".")+"_trackEvent",c,b,e,a]);this.s.debug&&this.s.debug_mode("event tracked as: "+c+" "+b+" "+e+" "+a)}},track_custom:function(c,b,e,a){if(this.s.track)for(var d=0;d<this.s.UA.length;d++)window._gaq.push([(0==d?"":"t"+(d+1)+".")+"_setCustomVar",c,b,e,a])},track_social:function(c,b,e,a){if(this.s.track)for(var d=0;d<this.s.UA.length;d++)window._gaq.push([(0==d?"":"t"+(d+1)+".")+"_trackSocial",c,b,e,a]),!this.s.auto_social&&self.s.debug&&self.s.debug_mode("NOTE: auto_social is off but track_social method called, make sure the api is included in the html")},track_transaction:function(c,b){if(this.s.track)for(var e=0;e<this.s.UA.length;e++){for(var a=0==e?"":"t"+(e+1)+".",d=0;d<c.length;d++)this.add_item(c[d],a);_gaq.push([a+"_addTrans",b[0],b[1],b[2],b[3],b[4],b[5],b[6],b[7]]);_gaq.push([a+"_trackTrans"])}},add_item:function(c,b){this.s.track&&_gaq.push([b+"_addItem",c[0],c[1],c[2],c[3],c[4],c[5]])}}})(jQuery);